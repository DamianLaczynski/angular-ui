<div
  #nodeElement
  [class]="treeNodeClasses()"
  [attr.role]="'treeitem'"
  [attr.aria-expanded]="hasChildren() ? (expanded() ? 'true' : 'false') : null"
  [attr.aria-selected]="node().selected ? 'true' : null"
  [attr.aria-disabled]="node().disabled ? 'true' : null"
  [attr.aria-level]="(node().level || 0) + 1"
  [attr.tabindex]="-1"
  (keydown)="onKeyDown($event)"
>
  <div class="tree-node__wrapper">
    <!-- Node Component -->
    <ui-node
      [node]="node()"
      [size]="size()"
      [variant]="variant()"
      [appearance]="appearance()"
      [shape]="shape()"
      [showSelectionIndicator]="showSelectionIndicator()"
      [indicatorPosition]="indicatorPosition()"
      [asButton]="asButton()"
      [selectOnClick]="selectOnClick()"
      [showQuickActions]="showQuickActions()"
      [quickActionsTemplate]="quickActionsTemplate() || null"
      [draggable]="draggable()"
      [dropZone]="dropZone() && draggedNodeId() !== node().id"
      (nodeClick)="onNodeClick($event)"
      (nodeSelect)="onNodeSelect($event)"
      (dragStart)="onDragStart($event)"
      (dragEnd)="onDragEnd($event)"
      (drop)="onDrop($event)"
      (dragOver)="onDragOver($event)"
    >
      <ng-template #content let-node>
        <div class="tree-node__content-wrapper">
          @if (shouldShowChevron() && chevronPosition() === 'before') {
            <span class="tree-node__chevron" (click)="onChevronClick($event)">
              @if (expanded()) {
                <ui-icon [icon]="chevronIconExpanded()" [size]="size()" />
              } @else {
                <ui-icon [icon]="chevronIconCollapsed()" [size]="size()" />
              }
            </span>
          }

          <div class="tree-node__content-main">
            @if (contentTemplate(); as template) {
              <!-- Custom content template (replaces icon and label) -->
              <ng-container
                *ngTemplateOutlet="template; context: { $implicit: node }"
              ></ng-container>
            } @else {
              <!-- Default icon and label -->
              @if (node.icon) {
                <span class="node__icon">
                  @if (node.selected) {
                    <ui-icon [icon]="node.icon" [size]="size()" variant="filled" />
                  } @else {
                    <ui-icon [icon]="node.icon" [size]="size()" variant="regular" />
                  }
                </span>
              }
              @if (node.label) {
                <span class="node__label">{{ node.label }}</span>
              }
            }
          </div>

          <div class="tree-node__content-end">
            @if (showQuickActions() && quickActionsTemplate()) {
              <div class="node__quick-actions">
                <ng-container
                  *ngTemplateOutlet="quickActionsTemplate()!; context: { $implicit: node }"
                ></ng-container>
              </div>
            }
            @if (shouldShowChevron() && chevronPosition() === 'after') {
              <span class="tree-node__chevron" (click)="onChevronClick($event)">
                @if (expanded()) {
                  <ui-icon [icon]="chevronIconExpanded()" [size]="size()" />
                } @else {
                  <ui-icon [icon]="chevronIconCollapsed()" [size]="size()" />
                }
              </span>
            }
          </div>
        </div>
      </ng-template>
    </ui-node>
  </div>

  <!-- Children (recursive) -->
  @if (expanded() && hasChildren() && node().children && node().children!.length > 0) {
    <div class="tree-node__children" role="group">
      @for (child of node().children; track child.id; let isFirst = $first; let isLast = $last) {
        <!-- Drop indicator before first child -->
        @if (dropZone() && isFirst && shouldRenderDropIndicator(child.id, 'before')) {
          <div
            class="node__drop-indicator node__drop-indicator--before"
            [class.node__drop-indicator--active]="shouldShowDropIndicator(child.id, 'before')"
            (dragenter)="
              onBetweenElementsDragOver($event, child, 'before');
              $event.preventDefault();
              $event.stopPropagation()
            "
            (dragover)="
              onBetweenElementsDragOver($event, child, 'before');
              $event.preventDefault();
              $event.stopPropagation()
            "
            (dragleave)="onBetweenElementsDragLeave($event); $event.stopPropagation()"
            (drop)="
              onBetweenElementsDrop($event, child, 'before');
              $event.preventDefault();
              $event.stopPropagation()
            "
          ></div>
        }

        <ui-tree-node
          [node]="child"
          [size]="size()"
          [variant]="variant()"
          [appearance]="appearance()"
          [shape]="shape()"
          [showSelectionIndicator]="showSelectionIndicator()"
          [indicatorPosition]="indicatorPosition()"
          [chevronPosition]="chevronPosition()"
          [chevronIconCollapsed]="chevronIconCollapsed()"
          [chevronIconExpanded]="chevronIconExpanded()"
          [asButton]="asButton()"
          [expandOnClick]="expandOnClick()"
          [selectOnClick]="selectOnClick()"
          [showQuickActions]="showQuickActions()"
          [quickActionsTemplate]="quickActionsTemplate() || null"
          [contentTemplate]="contentTemplate()"
          [draggable]="draggable()"
          [dropZone]="dropZone()"
          (nodeClick)="nodeClick.emit($event)"
          (nodeToggle)="nodeToggle.emit($event)"
          (nodeSelect)="nodeSelect.emit($event)"
          (dragStart)="dragStart.emit($event)"
          (dragEnd)="dragEnd.emit($event)"
          (drop)="drop.emit($event)"
          (dragOver)="onDragOver($event)"
        />

        <!-- Drop indicator after each child -->
        @if (dropZone() && shouldRenderDropIndicator(child.id, 'after')) {
          <div
            class="node__drop-indicator node__drop-indicator--after"
            [class.node__drop-indicator--active]="shouldShowDropIndicator(child.id, 'after')"
            (dragenter)="
              onBetweenElementsDragOver($event, child, 'after');
              $event.preventDefault();
              $event.stopPropagation()
            "
            (dragover)="
              onBetweenElementsDragOver($event, child, 'after');
              $event.preventDefault();
              $event.stopPropagation()
            "
            (dragleave)="onBetweenElementsDragLeave($event); $event.stopPropagation()"
            (drop)="
              onBetweenElementsDrop($event, child, 'after');
              $event.preventDefault();
              $event.stopPropagation()
            "
          ></div>
        }
      }
    </div>
  }
</div>
