<ui-field
  [fieldType]="'color'"
  [label]="label()"
  [placeholder]="placeholder()"
  [helpText]="helpText()"
  [(errorText)]="errorText"
  [required]="required()"
  [disabled]="disabled()"
  [readonly]="readonly()"
  [id]="id()"
  [name]="name()"
  [size]="size()"
  [inputVariant]="inputVariant()"
>
  <div class="input-wrapper" [class]="wrapperClasses">
    <!-- Color Preview -->
    @if (value) {
      <ui-icon
        [icon]="'square'"
        [size]="size()"
        variant="filled"
        [style.color]="value ? colorDisplayValue() : 'inherit'"
        class="color-preview"
        (click)="togglePanel()"
      ></ui-icon>
    }

    <input
      #triggerElement
      class="input"
      type="text"
      [id]="id()"
      [name]="name()"
      [placeholder]="placeholder()"
      [required]="required()"
      [disabled]="disabled()"
      [readonly]="readonly()"
      [value]="value || ''"
      [attr.aria-label]="ariaLabel() || label()"
      [attr.aria-describedby]="ariaDescribedBy()"
      [attr.aria-invalid]="!!errorText()"
      [attr.aria-expanded]="isExpanded()"
      [attr.aria-haspopup]="'dialog'"
      (click)="!disabled() && !readonly() ? togglePanel() : null"
      (input)="onColorInputChange($event)"
      (blur)="onBlur($event)"
      (focus)="onFocus($event)"
      (keydown)="onKeyDown($event)"
    />

    <!-- Actions: Eye dropper, color picker and clear button -->
    @if (!disabled() && !readonly()) {
      <div class="field__actions">
        <!-- Eye Dropper Button -->
        @if (showEyeDropper() && isEyeDropperSupported()) {
          <ui-action-button
            [icon]="'eyedropper'"
            [size]="size()"
            (click)="openEyeDropper()"
          ></ui-action-button>
        }
        <!-- Color Picker Icon Button -->
        <ui-action-button
          [icon]="'color'"
          [size]="size()"
          (click)="togglePanel()"
        ></ui-action-button>

        <!-- Clear Button -->
        @if (value) {
          <ui-action-button [icon]="'dismiss'" [size]="size()" (click)="clear()"></ui-action-button>
        }
      </div>
    }
  </div>
</ui-field>

<!-- Color Picker Panel - rendered via CDK Overlay -->
<ng-template #panelTemplate>
  <div class="color-panel" [attr.data-size]="size()" cdkTrapFocus>
    <!-- Saturation & Lightness Picker -->
    <div
      #saturationPicker
      class="color-picker"
      [style.background-color]="getHueColor()"
      (mousedown)="onSaturationPickerMouseDown($event)"
    >
      <div class="color-picker__overlay color-picker__overlay--white"></div>
      <div class="color-picker__overlay color-picker__overlay--black"></div>
      <div
        class="color-picker__handle"
        [style.left.px]="pickerX()"
        [style.top.px]="pickerY()"
      ></div>
    </div>

    <!-- Hue Slider -->
    <div class="color-slider">
      <label class="color-slider__label" [attr.for]="id() + '-hue'">Hue</label>
      <input
        type="range"
        class="color-slider__input color-slider__input--hue"
        [id]="id() + '-hue'"
        min="0"
        max="360"
        [value]="hueValue()"
        (input)="onHueChange($event)"
      />
    </div>

    <!-- Alpha Slider -->
    @if (showAlpha()) {
      <div class="color-slider">
        <label class="color-slider__label" [attr.for]="id() + '-alpha'">Opacity</label>
        <div class="color-slider__alpha-wrapper">
          <div class="color-slider__alpha-checkered"></div>
          <input
            type="range"
            class="color-slider__input color-slider__input--alpha"
            [id]="id() + '-alpha'"
            min="0"
            max="1"
            step="0.01"
            [value]="alphaValue()"
            [style.background]="
              'linear-gradient(to right, transparent, ' + currentColor().hex + ')'
            "
            (input)="onAlphaChange($event)"
          />
        </div>
      </div>
    }
  </div>
</ng-template>
