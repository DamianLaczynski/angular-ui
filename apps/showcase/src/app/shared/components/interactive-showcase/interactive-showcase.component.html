<div class="interactive-showcase">
  <!-- Header -->
  <div class="interactive-showcase__header">
    <div class="interactive-showcase__toolbar">
      <!-- Viewport Controls -->
      @if (showViewportControls()) {
      <div class="interactive-showcase__viewport-controls">
        @for (option of viewportOptions; track option.value) {
        <ui-button
          variant="secondary"
          [appearance]="currentViewport() === option.value ? 'filled' : 'subtle'"
          [icon]="option.icon"
          [ariaLabel]="option.label"
          (click)="setViewport(option.value)"
        />
        }
      </div>
      <div class="interactive-showcase__separator"></div>
      }

      <ui-button
        variant="secondary"
        appearance="subtle"
        icon="arrow_reset"
        ariaLabel="Reset"
        (click)="onReset()"
      />
      <ui-button
        variant="secondary"
        appearance="subtle"
        [icon]="isDarkTheme() ? 'weather_sunny' : 'weather_moon'"
        ariaLabel="Toggle theme"
        (click)="toggleTheme()"
      />
      @if (showCopyCode() && config()?.componentSelector) {
      <ui-button
        variant="primary"
        [appearance]="isCodePanelOpen() ? 'filled' : 'subtle'"
        icon="code"
        ariaLabel="Toggle code"
        (click)="toggleCodePanel()"
      />
      }
    </div>
  </div>

  <!-- Preview Area with Viewport -->
  <div class="interactive-showcase__preview-wrapper">
    <div
      #previewContainer
      class="interactive-showcase__preview"
      [class.interactive-showcase__preview--dark]="isDarkTheme()"
      [class.interactive-showcase__preview--resizing]="isResizing()"
      [style.width]="previewWidth()"
    >
      <ng-content select="[preview]"></ng-content>

      <!-- Resize Handle -->
      @if (currentViewport() === 'custom' || currentViewport() !== 'desktop') {
      <div class="interactive-showcase__resize-handle" (mousedown)="onResizeStart($event)">
        <div class="interactive-showcase__resize-handle-bar"></div>
      </div>
      }
    </div>

    <!-- Viewport Width Indicator -->
    @if (currentViewport() !== 'desktop') {
    <div class="interactive-showcase__viewport-indicator">
      {{ currentViewport() === 'custom' ? customWidth() + 'px' : previewWidth() }}
    </div>
    }
  </div>

  <!-- Code Panel (Accordion) -->
  @if (showCopyCode() && config()?.componentSelector) {
  <div class="interactive-showcase__code-panel">
    <button
      type="button"
      class="interactive-showcase__code-header"
      [class.interactive-showcase__code-header--expanded]="isCodePanelOpen()"
      (click)="toggleCodePanel()"
    >
      <div class="interactive-showcase__code-header-content">
        <ui-icon [icon]="isCodePanelOpen() ? 'chevron_down' : 'chevron_right'" size="small" />
        <span>Generated Code</span>
      </div>
      <ui-button
        variant="secondary"
        size="small"
        appearance="subtle"
        [icon]="codeCopied() ? 'checkmark' : 'copy'"
        [ariaLabel]="codeCopied() ? 'Copied!' : 'Copy code'"
        (click)="copyCodeToClipboard(); $event.stopPropagation()"
      />
    </button>

    @if (isCodePanelOpen()) {
    <pre
      class="interactive-showcase__code"
    ><code class="interactive-showcase__code-content">{{ generatedCode() }}</code></pre>
    }
  </div>
  }

  <!-- Controls Area - Property Table -->
  @if (config()?.controls?.length) {
  <div class="interactive-showcase__controls">
    <div class="interactive-showcase__controls-header">
      <h4 class="interactive-showcase__controls-title">Properties</h4>
      @if (controlGroups()) {
      <div class="interactive-showcase__controls-actions">
        <ui-button
          variant="secondary"
          size="small"
          appearance="subtle"
          icon="chevron_down_up"
          ariaLabel="Expand all"
          (click)="expandAllGroups()"
        />
        <ui-button
          variant="secondary"
          size="small"
          appearance="subtle"
          icon="chevron_up_down"
          ariaLabel="Collapse all"
          (click)="collapseAllGroups()"
        />
      </div>
      }
    </div>

    <!-- Grouped Controls -->
    @if (controlGroups(); as groups) { @for (group of groups; track group.id) {
    <div class="interactive-showcase__group">
      <button
        type="button"
        class="interactive-showcase__group-header"
        [class.interactive-showcase__group-header--expanded]="isGroupExpanded(group.id)"
        (click)="toggleGroup(group.id)"
      >
        <ui-icon
          [icon]="isGroupExpanded(group.id) ? 'chevron_down' : 'chevron_right'"
          size="small"
        />
        @if (group.icon) {
        <ui-icon [icon]="group.icon" size="small" />
        }
        <span class="interactive-showcase__group-label">{{ group.label }}</span>
        <span class="interactive-showcase__group-count">{{ group.controls.length }}</span>
      </button>

      @if (isGroupExpanded(group.id)) {
      <table class="interactive-showcase__props-table">
        <thead>
          <tr>
            <th class="interactive-showcase__th interactive-showcase__th--name">Name</th>
            <th class="interactive-showcase__th interactive-showcase__th--type">Type</th>
            <th class="interactive-showcase__th interactive-showcase__th--desc">Description</th>
            <th class="interactive-showcase__th interactive-showcase__th--control">Value</th>
          </tr>
        </thead>
        <tbody>
          @for (control of group.controls; track control.key) {
          <ng-container
            *ngTemplateOutlet="controlRow; context: { control: control }"
          ></ng-container>
          }
        </tbody>
      </table>
      }
    </div>
    } } @else {
    <!-- Ungrouped Controls (flat list) -->
    <table class="interactive-showcase__props-table">
      <thead>
        <tr>
          <th class="interactive-showcase__th interactive-showcase__th--name">Name</th>
          <th class="interactive-showcase__th interactive-showcase__th--type">Type</th>
          <th class="interactive-showcase__th interactive-showcase__th--desc">Description</th>
          <th class="interactive-showcase__th interactive-showcase__th--control">Value</th>
        </tr>
      </thead>
      <tbody>
        @for (control of config()?.controls; track control.key) {
        <ng-container *ngTemplateOutlet="controlRow; context: { control: control }"></ng-container>
        }
      </tbody>
    </table>
    }
  </div>
  }

  <!-- Control Row Template -->
  <ng-template #controlRow let-control="control">
    <tr class="interactive-showcase__prop-row">
      <td class="interactive-showcase__td interactive-showcase__td--name">
        <code class="interactive-showcase__prop-name">{{ control.key }}</code>
      </td>
      <td class="interactive-showcase__td interactive-showcase__td--type">
        <span class="interactive-showcase__prop-type">{{ getControlTypeName(control) }}</span>
      </td>
      <td class="interactive-showcase__td interactive-showcase__td--desc">
        @if (control.description) {
        <span class="interactive-showcase__prop-desc">{{ control.description }}</span>
        } @else {
        <span class="interactive-showcase__prop-desc interactive-showcase__prop-desc--empty"
          >-</span
        >
        }
      </td>
      <td class="interactive-showcase__td interactive-showcase__td--control">
        @switch (control.type) { @case ('dropdown') {
        <ui-dropdown
          [items]="getDropdownItems(control)"
          [ngModel]="getControlValue(control.key)"
          (selectionChange)="onControlChange(control.key, $event)"
          size="small"
        />
        } @case ('text') {
        <ui-text
          [ngModel]="getControlValue(control.key)"
          (ngModelChange)="onTextChange(control.key, $event)"
          [placeholder]="control.placeholder || ''"
          size="small"
        />
        } @case ('textarea') {
        <ui-textarea
          [ngModel]="getControlValue(control.key)"
          (ngModelChange)="onTextChange(control.key, $event)"
          [placeholder]="control.placeholder || ''"
          [rows]="control.rows || 3"
          size="small"
        />
        } @case ('number') {
        <ui-number
          [ngModel]="getControlValue(control.key)"
          (ngModelChange)="onTextChange(control.key, $event)"
          [min]="control.min"
          [max]="control.max"
          [step]="control.step || 1"
          size="small"
        />
        } @case ('switch') {
        <ui-switch
          [ngModel]="getControlValue(control.key)"
          (ngModelChange)="onTextChange(control.key, $event)"
          size="small"
        />
        } @case ('color') {
        <input
          type="color"
          class="interactive-showcase__color-input"
          [ngModel]="getControlValue(control.key)"
          (ngModelChange)="onTextChange(control.key, $event)"
          size="small"
        />
        } }
      </td>
    </tr>
  </ng-template>

  <!-- Event Log Area -->
  @if (showEventLog()) {
  <div class="interactive-showcase__event-log">
    <div class="interactive-showcase__event-log-header">
      <span>Events</span>
      @if (eventLog().length > 0) {
      <ui-button
        variant="danger"
        size="small"
        appearance="subtle"
        icon="delete"
        ariaLabel="Clear log"
        (click)="clearEventLog()"
      />
      }
    </div>
    <div class="interactive-showcase__event-log-content">
      @if (eventLog().length === 0) {
      <div class="interactive-showcase__event-log-empty">
        Interact with the component to see events...
      </div>
      } @else { @for (event of eventLog(); track $index) {
      <div class="interactive-showcase__event-log-item">
        <span class="interactive-showcase__event-log-time">{{ event.timestamp }}</span>
        <code class="interactive-showcase__event-log-name">{{ event.name }}</code>
        @if (event.data !== undefined) {
        <span class="interactive-showcase__event-log-data">{{ formatEventData(event.data) }}</span>
        }
      </div>
      } }
    </div>
  </div>
  }
</div>
